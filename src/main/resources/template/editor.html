<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{serverUrl}}resources/vditor/dist/index.css"/>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; }
        #vditor { height: 100%; }
        .vditor { border: none !important; }
        .vditor-toolbar { display: none !important; }

        /* Plain source editor */
        #source-editor {
            display: none;
            width: 100%;
            height: calc(100% - 24px);
            border: none;
            outline: none;
            resize: none;
            padding: 16px 24px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            line-height: 1.6;
            tab-size: 4;
            background: var(--source-bg, #fff);
            color: var(--source-fg, #333);
        }
        #source-editor.dark {
            --source-bg: #1e1e1e;
            --source-fg: #d4d4d4;
        }

        /* Mode indicator in status bar */
        #status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            font-size: 12px;
            background: var(--status-bg, #f5f5f5);
            color: var(--status-fg, #666);
            border-top: 1px solid var(--border-color, #e0e0e0);
            z-index: 100;
        }
        #status-bar.dark {
            --status-bg: #2b2b2b;
            --status-fg: #999;
            --border-color: #3c3c3c;
        }
        #status-bar .mode-btn {
            cursor: pointer;
            padding: 2px 8px;
            border-radius: 3px;
            user-select: none;
        }
        #status-bar .mode-btn:hover {
            background: rgba(128,128,128,0.2);
        }
        #status-bar .mode-btn.active {
            font-weight: bold;
        }
        #save-status { opacity: 0.7; }
    </style>
</head>
<body>
    <div id="vditor"></div>
    <textarea id="source-editor" spellcheck="false"></textarea>
    <div id="status-bar">
        <span id="save-status">Ready</span>
        <span>
            <span id="mode-wysiwyg" class="mode-btn active" onclick="switchMode('wysiwyg')">WYSIWYG</span>
            <span id="mode-sv" class="mode-btn" onclick="switchMode('sv')">Source</span>
        </span>
    </div>

    <script src="{{serverUrl}}resources/vditor/dist/index.min.js"></script>
    <script>
        const SERVER_URL = '{{serverUrl}}';
        const FILE_PATH = '{{filePath}}';
        const IS_DARK = {{darcula}};

        let vditor;
        let isDirty = false;
        let saveTimeout = null;
        let currentMode = 'wysiwyg';

        // Apply dark class
        if (IS_DARK) {
            document.getElementById('status-bar').classList.add('dark');
            document.getElementById('source-editor').classList.add('dark');
        }

        function initEditor() {
            vditor = new Vditor('vditor', {
                mode: 'wysiwyg',
                value: '',
                height: '100%',
                cache: { enable: false },
                theme: IS_DARK ? 'dark' : 'classic',
                cdn: SERVER_URL + 'resources/vditor',
                toolbar: [],
                upload: {
                    url: SERVER_URL + 'api/upload?filePath=' + encodeURIComponent(FILE_PATH),
                    accept: 'image/*',
                    multiple: true,
                    fieldName: 'file[]',
                    filename: function(name) {
                        return name;
                    },
                    format: function(files, responseText) {
                        try {
                            var resp = JSON.parse(responseText);
                            if (resp.code === 0 && resp.data && resp.data.succMap) {
                                var newSuccMap = {};
                                var mdDir = FILE_PATH.substring(0, FILE_PATH.lastIndexOf('/'));
                                for (var origName in resp.data.succMap) {
                                    var relativePath = resp.data.succMap[origName];
                                    var absolutePath = mdDir + '/' + relativePath;
                                    var imageUrl = SERVER_URL + 'api/local-image?path=' + encodeURIComponent(absolutePath);
                                    newSuccMap[origName] = imageUrl;
                                }
                                return JSON.stringify({ msg: '', code: 0, data: { succMap: newSuccMap } });
                            }
                        } catch(e) {
                            console.error('Upload format error:', e);
                        }
                        return responseText;
                    }
                },
                tab: '    ',
                typewriterMode: false,
                preview: {
                    theme: {
                        current: IS_DARK ? 'dark' : 'light'
                    },
                    hljs: {
                        enable: true,
                        style: IS_DARK ? 'native' : 'github',
                        lineNumber: true
                    },
                    math: {
                        engine: 'KaTeX'
                    }
                },
                hint: {
                    emoji: {
                        '+1': 'ðŸ‘',
                        '-1': 'ðŸ‘Ž',
                        'heart': 'â¤ï¸',
                        'smile': 'ðŸ˜„',
                        'laugh': 'ðŸ˜†',
                        'think': 'ðŸ¤”',
                        'fire': 'ðŸ”¥',
                        'star': 'â­',
                        'check': 'âœ…',
                        'x': 'âŒ',
                        'warning': 'âš ï¸',
                        'bug': 'ðŸ›',
                        'rocket': 'ðŸš€',
                        'tada': 'ðŸŽ‰'
                    },
                    extend: [
                        {
                            key: '/',
                            hint: function(key) {
                                return filterSlashCommands(key);
                            }
                        }
                    ]
                },
                input: function(value) {
                    isDirty = true;
                    updateSaveStatus('Modified');
                    debounceSave(value);
                },
                blur: function(value) {
                    if (isDirty) {
                        saveToFile(value);
                    }
                },
                focus: function(value) {
                    // Reload if file changed externally
                    checkExternalChanges();
                },
                after: function() {
                    initValue();
                    // Track mode changes from Vditor's built-in edit-mode button
                    observeModeChange();
                }
            });
        }

        async function initValue() {
            try {
                const resp = await fetch(SERVER_URL + 'api/file/read?path=' + encodeURIComponent(FILE_PATH));
                const data = await resp.json();
                if (data.content !== undefined) {
                    vditor.setValue(data.content);
                    isDirty = false;
                    updateSaveStatus('Ready');
                }
            } catch (e) {
                console.error('Failed to load file:', e);
                updateSaveStatus('Load failed');
            }
        }

        let lastKnownContent = null;

        async function checkExternalChanges() {
            try {
                const resp = await fetch(SERVER_URL + 'api/file/read?path=' + encodeURIComponent(FILE_PATH));
                const data = await resp.json();
                if (data.content !== undefined && lastKnownContent !== null) {
                    if (data.content !== lastKnownContent && !isDirty) {
                        vditor.setValue(data.content);
                        lastKnownContent = data.content;
                    }
                }
            } catch (e) {
                // ignore
            }
        }

        function debounceSave(content) {
            if (saveTimeout) {
                clearTimeout(saveTimeout);
            }
            saveTimeout = setTimeout(function() {
                saveToFile(content);
            }, 1000);
        }

        async function saveToFile(content) {
            try {
                updateSaveStatus('Saving...');
                await fetch(SERVER_URL + 'api/file/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: FILE_PATH,
                        content: content
                    })
                });
                isDirty = false;
                lastKnownContent = content;
                updateSaveStatus('Saved');
                setTimeout(function() {
                    if (!isDirty) updateSaveStatus('Ready');
                }, 2000);
            } catch (e) {
                console.error('Failed to save file:', e);
                updateSaveStatus('Save failed');
            }
        }

        function updateSaveStatus(status) {
            document.getElementById('save-status').textContent = status;
        }

        function switchMode(mode) {
            if (mode === currentMode) return;
            var vditorEl = document.getElementById('vditor');
            var sourceEl = document.getElementById('source-editor');

            if (mode === 'sv') {
                // WYSIWYG -> Source: get content from Vditor, show textarea
                var content = vditor ? vditor.getValue() : '';
                if (isDirty && vditor) {
                    saveToFile(content);
                }
                sourceEl.value = content;
                vditorEl.style.display = 'none';
                sourceEl.style.display = 'block';
                sourceEl.focus();
            } else {
                // Source -> WYSIWYG: get content from textarea, show Vditor
                var content = sourceEl.value;
                sourceEl.style.display = 'none';
                vditorEl.style.display = 'block';
                if (vditor) {
                    vditor.setValue(content);
                }
                isDirty = false;
            }
            currentMode = mode;
            updateModeIndicator(mode);
        }

        // Source editor input handling
        (function() {
            var sourceEl = document.getElementById('source-editor');
            var sourceTimeout = null;
            sourceEl.addEventListener('input', function() {
                isDirty = true;
                updateSaveStatus('Modified');
                if (sourceTimeout) clearTimeout(sourceTimeout);
                sourceTimeout = setTimeout(function() {
                    saveToFile(sourceEl.value);
                }, 1000);
            });
            sourceEl.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    var start = this.selectionStart;
                    var end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 4;
                    this.dispatchEvent(new Event('input'));
                }
            });
        })();

        function updateModeIndicator(mode) {
            document.getElementById('mode-wysiwyg').classList.toggle('active', mode === 'wysiwyg');
            document.getElementById('mode-sv').classList.toggle('active', mode === 'sv');
        }

        function observeModeChange() {
            // Watch for mode changes from Vditor's built-in edit-mode toolbar button
            var observer = new MutationObserver(function() {
                if (vditor) {
                    var mode = vditor.getCurrentMode();
                    if (mode !== currentMode) {
                        currentMode = mode;
                        updateModeIndicator(mode);
                    }
                }
            });
            var vditorEl = document.getElementById('vditor');
            if (vditorEl) {
                observer.observe(vditorEl, { attributes: true, childList: true, subtree: true });
            }
        }

        function switchTheme(isDark) {
            if (vditor) {
                vditor.setTheme(
                    isDark ? 'dark' : 'classic',
                    isDark ? 'dark' : 'light',
                    isDark ? 'native' : 'github'
                );
            }
            document.getElementById('status-bar').classList.toggle('dark', isDark);
            document.getElementById('source-editor').classList.toggle('dark', isDark);
        }

        // Open links in external browser via JCEF
        document.addEventListener('click', function(e) {
            var target = e.target;
            while (target && target.tagName !== 'A') {
                target = target.parentElement;
            }
            if (target && target.href && target.href.startsWith('http')) {
                e.preventDefault();
                e.stopPropagation();
                // JCEF will handle external URL opening
                window.open(target.href, '_blank');
            }
        }, true);

        async function exportFile(format) {
            try {
                if (isDirty) {
                    await saveToFile(vditor.getValue());
                }
                var url = SERVER_URL + 'api/export?format=' + format + '&path=' + encodeURIComponent(FILE_PATH);
                var resp = await fetch(url);
                var data = await resp.json();
                if (data.error) {
                    updateSaveStatus('Export failed: ' + data.error);
                } else {
                    updateSaveStatus('Exported: ' + data.msg);
                    setTimeout(function() {
                        if (!isDirty) updateSaveStatus('Ready');
                    }, 3000);
                }
            } catch(e) {
                console.error('Export failed:', e);
                updateSaveStatus('Export failed');
            }
        }

        function filterSlashCommands(query) {
            var commands = [
                // Basic Blocks
                { value: '# ', html: '<b>/h1</b> &nbsp; Heading 1' },
                { value: '## ', html: '<b>/h2</b> &nbsp; Heading 2' },
                { value: '### ', html: '<b>/h3</b> &nbsp; Heading 3' },
                { value: '#### ', html: '<b>/h4</b> &nbsp; Heading 4' },
                { value: '##### ', html: '<b>/h5</b> &nbsp; Heading 5' },
                { value: '###### ', html: '<b>/h6</b> &nbsp; Heading 6' },
                { value: '', html: '<b>/text</b> &nbsp; Plain text' },
                { value: '- ', html: '<b>/bullet</b> &nbsp; Bulleted list' },
                { value: '1. ', html: '<b>/num</b> &nbsp; Numbered list' },
                { value: '- [ ] ', html: '<b>/todo</b> &nbsp; Checklist' },
                { value: '> ', html: '<b>/quote</b> &nbsp; Quote block' },
                { value: '---\n', html: '<b>/div</b> &nbsp; Divider' },
                // Media
                { value: '```\n', html: '<b>/code</b> &nbsp; Code block' },
                { value: '| Col1 | Col2 | Col3 |\n| --- | --- | --- |\n| | | |\n', html: '<b>/table</b> &nbsp; Table' },
                { value: '![image]()', html: '<b>/image</b> &nbsp; Image' },
                // Math
                { value: '$E = mc^2$', html: '<b>/equation</b> &nbsp; Inline equation' },
                { value: '$$\n\n$$', html: '<b>/math</b> &nbsp; Math block' },
                // Diagram
                { value: '```mermaid\ngraph TD\n    A[Start] --> B[End]\n```\n', html: '<b>/mermaid</b> &nbsp; Mermaid diagram' },
                // Navigation
                { value: '[TOC]\n', html: '<b>/toc</b> &nbsp; Table of contents' },
                // Utility
                { value: ':emoji:', html: '<b>/emoji</b> &nbsp; Emoji picker' }
            ];

            if (!query) return commands;
            var q = query.toLowerCase();
            return commands.filter(function(cmd) {
                return cmd.html.toLowerCase().indexOf(q) !== -1;
            });
        }

        initEditor();
    </script>
</body>
</html>
